{% extends 'base.html' %}

{% block content %}
<div class="flex">
    <!-- Sidebar de filtros -->
    <div class="w-1/4 p-4">
        <div class="bg-white rounded-2xl shadow p-4 space-y-4">
            <h2 class="text-xl font-semibold border-b pb-2">Filtrar variantes</h2>

            <label for="variantFilter" class="block text-sm font-medium text-gray-700">Código de variante</label>
            <select id="variantFilter" class="w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="">Todas las variantes</option>
                {% for variant in variants %}
                    <option value="{{ variant.id }}">{{ variant.product.name }} - {{ variant.variant_code }}</option>
                {% endfor %}
            </select>

            <button id="clearFilter" class="w-full mt-2 px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-800 rounded-lg transition">
                Limpiar filtro
            </button>

            <!-- Card de detalles de la variante -->
            <div id="variantInfo" class="hidden bg-gray-50 rounded-xl p-4 border mt-4 shadow-sm space-y-2">
                <div class="flex items-center space-x-4">
                    <img id="variantImage" src="" alt="Producto" class="w-20 h-20 object-cover rounded-lg border" />
                    <div>
                        <h3 id="variantProductName" class="text-lg font-bold">Nombre del producto</h3> <!-- Asegúrate de que tenga contenido -->
                        <p id="variantCategory" class="text-sm text-gray-600"></p>
                    </div>
                </div>
                <div class="text-sm mt-2">
                    <p><strong>Código de Variante:</strong> <span id="variantCode"></span></p>
                    <p><strong>Precio:</strong> $<span id="variantPrice"></span></p>
                    <p><strong>Stock Total:</strong> <span id="variantStock"></span></p>
                    <p><strong>Atributos:</strong> <span id="variantAttributes"></span></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Mapa -->
    <div class="w-3/4">
        <div id="map" style="height: 600px;" class="rounded shadow"></div>
    </div>
</div>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const map = L.map("map").setView([6.2442, -75.5812], 11);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "&copy; OpenStreetMap contributors",
    }).addTo(map);
    const inventoryData = JSON.parse(`{{ inventory_data|escapejs }}`);
    let currentMarkers = [];
    
    function updateMap(variantId) {
        // Limpiar marcadores actuales
        currentMarkers.forEach(marker => map.removeLayer(marker));
        currentMarkers = [];
        const filtered = inventoryData.filter(item => !variantId || item.variant_id == variantId);
        filtered.forEach(item => {
            const lat = item.warehouse.latitude;
            const lon = item.warehouse.longitude;
            if (lat && lon) {
                const marker = L.marker([lat, lon])
                    .addTo(map)
                    .bindPopup(`
                        <strong>${item.variant_name}</strong><br>
                        Bodega: ${item.warehouse.name}<br>
                        Cantidad: ${item.quantity}
                    `);
                currentMarkers.push(marker);
            }
        });
        if (filtered.length > 0) {
            const first = filtered[0].warehouse;
            map.setView([first.latitude, first.longitude], 13);
        }
        // Mostrar detalles de la tarjeta
        const card = document.getElementById("variantInfo");
        if (variantId && filtered.length > 0) {
            const first = filtered[0];
            const totalStock = filtered.reduce((sum, i) => sum + i.quantity, 0);
            document.getElementById("variantImage").src = first.product_image;
            document.getElementById("variantProductName").textContent = first.product_name;
            document.getElementById("variantCategory").textContent = first.category_name;
            document.getElementById("variantCode").textContent = first.variant_code;
            document.getElementById("variantPrice").textContent = first.price;
            document.getElementById("variantStock").textContent = totalStock;
            document.getElementById("variantAttributes").textContent = first.attributes;
            // Mostrar la tarjeta de detalles
            card.classList.remove("hidden");
        }
    }

    // Evento al seleccionar variante
    document.getElementById("variantFilter").addEventListener("change", function () {
        updateMap(this.value);
    });

    // Carga inicial sin filtros
    updateMap(null);

    document.getElementById("clearFilter").addEventListener("click", function () {
        document.getElementById("variantFilter").value = "";
        updateMap(null);
    });
});
</script>
{% endblock %}
