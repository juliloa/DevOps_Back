{% extends 'base.html' %}

{% block content %}
<div class="flex">
    <!-- Sidebar de filtros -->
    <div class="w-1/4 p-4">
        <div class="bg-white rounded-2xl shadow p-4 space-y-4">
            <h2 class="text-xl font-semibold border-b pb-2">Filtrar variantes</h2>

            <!-- Filtro con input + lista -->
            <label for="variantFilterInput" class="block text-sm font-medium text-gray-700">Buscar código de variante</label>
            <input
                type="text"
                id="variantFilterInput"
                placeholder="Escribe código de variante..."
                class="w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
            <ul id="variantList" class="border border-gray-300 rounded mt-1 max-h-48 overflow-auto hidden bg-white shadow-sm"></ul>

            <!-- Selector de bodega -->
            <label for="warehouseFilter" class="block text-sm font-medium text-gray-700 mt-4">Filtrar por bodega</label>
            <select id="warehouseFilter" class="w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="">Todas las bodegas</option>
                {% for bodega in warehouses %}
                    <option value="{{ bodega.id }}">{{ bodega.name }}</option>
                {% endfor %}
            </select>

            <!-- Botón limpiar -->
            <button id="clearFilter" class="w-full mt-2 px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-800 rounded-lg transition">
                Limpiar filtro
            </button>

            <!-- Card de detalles de la variante -->
            <div id="variantInfo" class="hidden bg-gray-50 rounded-xl p-4 border mt-4 shadow-sm space-y-2">
                <div class="flex items-center space-x-4">
                    <img id="variantImage" src="" alt="Producto" class="w-20 h-20 object-cover rounded-lg border" />
                    <div>
                        <h3 id="variantProductName" class="text-lg font-bold">Nombre del producto</h3>
                        <p id="variantCategory" class="text-sm text-gray-600"></p>
                    </div>
                </div>
                <div class="text-sm mt-2">
                    <p><strong>Código de Variante:</strong> <span id="variantCode"></span></p>
                    <p><strong>Precio:</strong> $<span id="variantPrice"></span></p>
                    <p><strong>Stock Total:</strong> <span id="variantStock"></span></p>
                    <p><strong>Atributos:</strong> <span id="variantAttributes"></span></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Mapa -->
    <div class="w-3/4">
        <div id="map" style="height: 600px;" class="rounded shadow"></div>
    </div>
</div>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" integrity="sha384-sHL9NAb7lN7rfvG5lfHpm643Xkcjzp4jFvuavGOndn6pjVqS6ny56CAt3nsEVT4H" crossorigin="anonymous">
<script src="https://unpkg.com/leaflet/dist/leaflet.js" integrity="sha384-cxOPjt7s7Iz04uaHJceBmS+qpjv2JkIHNVcuOrM+YHwZOmJGBXI00mdUXEq65HTH" crossorigin="anonymous"></script>

<!-- Datos para JavaScript -->
{{ variants|json_script:"variantsData" }}
<script>
document.addEventListener("DOMContentLoaded", function () {
    const map = L.map("map").setView([6.2442, -75.5812], 11);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "&copy; OpenStreetMap contributors",
    }).addTo(map);

    const inventoryData = JSON.parse(`{{ inventory_data|escapejs }}`);
    const variantsData = JSON.parse(document.getElementById("variantsData").textContent);

    const variantFilterInput = document.getElementById("variantFilterInput");
    const warehouseFilter = document.getElementById("warehouseFilter");
    const variantList = document.getElementById("variantList");
    const clearButton = document.getElementById("clearFilter");
    const card = document.getElementById("variantInfo");

    let currentMarkers = [];
    let selectedVariantId = null;
    let selectedWarehouseId = "";

    function updateMap() {
    currentMarkers.forEach(marker => map.removeLayer(marker));
    currentMarkers = [];

    let filtered = inventoryData;

    if (selectedVariantId) {
        filtered = filtered.filter(item => item.variant_id == selectedVariantId);
    }

    if (selectedWarehouseId) {
        filtered = filtered.filter(item => item.warehouse.id == selectedWarehouseId);
    }

    if (!selectedVariantId) {
        // Agrupar por bodega
        const warehousesMap = {};
        filtered.forEach(item => {
            const wid = item.warehouse.id;
            if (!warehousesMap[wid]) {
                warehousesMap[wid] = {
                    warehouse: item.warehouse,
                    variants: []
                };
            }
            warehousesMap[wid].variants.push(item);
        });

        Object.values(warehousesMap).forEach(entry => {
            const lat = entry.warehouse.latitude;
            const lon = entry.warehouse.longitude;
            if (lat && lon) {
                const popupHtml = `
                    <strong>${entry.warehouse.name}</strong><br>
                    <u>Variantes en esta bodega:</u><br>
                    <ul style="padding-left: 1rem; margin-top: 0.3rem;">
                        ${entry.variants.map(v =>
                            `<li>• ${v.variant_name} (${v.quantity} unidades)</li>`
                        ).join('')}
                    </ul>
                `;
                const marker = L.marker([lat, lon])
                    .addTo(map)
                    .bindPopup(popupHtml);
                currentMarkers.push(marker);
            }
        });

    } else {
        // Mostrar marcador normal por variante
        filtered.forEach(item => {
            const lat = item.warehouse.latitude;
            const lon = item.warehouse.longitude;
            if (lat && lon) {
                const marker = L.marker([lat, lon])
                    .addTo(map)
                    .bindPopup(`
                        <strong>${item.variant_name}</strong><br>
                        Bodega: ${item.warehouse.name}<br>
                        Cantidad: ${item.quantity}
                    `);
                currentMarkers.push(marker);
            }
        });
    }

    // Centrar el mapa si hay resultados
    if (filtered.length > 0) {
        const first = filtered[0].warehouse;
        map.setView([first.latitude, first.longitude], 13);
    }

    // Mostrar tarjeta solo si hay una variante seleccionada
    if (selectedVariantId && filtered.length > 0) {
        const first = filtered[0];
        const totalStock = inventoryData
            .filter(item => item.variant_id == selectedVariantId)
            .reduce((sum, i) => sum + i.quantity, 0);
        document.getElementById("variantImage").src = first.product_image;
        document.getElementById("variantProductName").textContent = first.product_name;
        document.getElementById("variantCategory").textContent = first.category_name;
        document.getElementById("variantCode").textContent = first.variant_code;
        document.getElementById("variantPrice").textContent = first.price;
        document.getElementById("variantStock").textContent = totalStock;
        document.getElementById("variantAttributes").textContent = first.attributes;
        card.classList.remove("hidden");
    } else {
        card.classList.add("hidden");
    }
}


    function showFilteredVariants(query) {
        variantList.innerHTML = "";

        const filtered = !query
            ? variantsData
            : variantsData.filter(v =>
                v.variant_code.toLowerCase().includes(query.toLowerCase())
            );

        if (filtered.length === 0) {
            variantList.innerHTML = "<li class='p-2 text-gray-500'>No hay variantes</li>";
            variantList.classList.remove("hidden");
            return;
        }

        filtered.forEach(v => {
            const li = document.createElement("li");
            li.textContent = v.variant_code;
            li.className = "p-2 cursor-pointer hover:bg-blue-100";
            li.dataset.id = v.id;
            variantList.appendChild(li);
        });

        variantList.classList.remove("hidden");
    }

    variantFilterInput.addEventListener("input", e => {
        showFilteredVariants(e.target.value);
    });

    variantFilterInput.addEventListener("focus", () => {
        showFilteredVariants(variantFilterInput.value);
    });

    variantList.addEventListener("click", e => {
        if (e.target.tagName === "LI" && e.target.dataset.id) {
            selectedVariantId = e.target.dataset.id;
            variantFilterInput.value = e.target.textContent;
            variantList.classList.add("hidden");
            updateMap();
        }
    });

    warehouseFilter.addEventListener("change", e => {
        selectedWarehouseId = e.target.value;
        updateMap();
    });

    clearButton.addEventListener("click", () => {
        selectedVariantId = null;
        selectedWarehouseId = "";
        variantFilterInput.value = "";
        warehouseFilter.value = "";
        variantList.classList.add("hidden");
        updateMap();
    });

    updateMap();
});
</script>
{% endblock %}
