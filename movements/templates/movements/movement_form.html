{% extends 'base.html' %}

{% block content %}
<div class="p-6 max-w-4xl mx-auto">
    <h1 class="text-3xl font-semibold mb-6">Crear Movimiento</h1>

    <!-- Aquí el cambio importante: action apunta a 'movement-create-submit' -->
    <form method="post" action="{% url 'movement-create-submit' %}" id="movement-form" class="bg-white p-6 rounded-lg shadow-md">
        {% csrf_token %}

        <div class="form-group mb-6">
            <label for="id_variant" class="block text-gray-700 font-semibold mb-2">Variante</label>
            {{ form.variant }}
        </div>

        <div class="form-group mb-6">
            <label for="id_source_warehouse" class="block text-gray-700 font-semibold mb-2">Bodega de Origen</label>
            {{ form.source_warehouse }}
            <div id="stock-info" class="text-sm text-gray-500 mt-2"></div>
        </div>

        <div class="form-group mb-6">
            <label for="id_destination_warehouse" class="block text-gray-700 font-semibold mb-2">Bodega de Destino</label>
            {{ form.destination_warehouse }}
        </div>

        <div class="form-group mb-6">
            <label for="id_quantity" class="block text-gray-700 font-semibold mb-2">Cantidad</label>
            {{ form.quantity }}
        </div>

        <div class="form-group mb-6">
            <label for="id_reason" class="block text-gray-700 font-semibold mb-2">Razón</label>
            {{ form.reason }}
        </div>

        <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">Crear Movimiento</button>
    </form>
</div>

<style>
    select, input[type="text"], input[type="number"] {
        width: 100%;
        padding: 8px;
        border-radius: 5px;
        border: 1px solid #ccc;
    }
    button {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 5px;
        cursor: pointer;
    }
    button:hover {
        background: #0056b3;
    }
</style>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const variantSelect = document.getElementById("id_variant");
        const sourceWarehouseSelect = document.getElementById("id_source_warehouse");
        const destinationWarehouseSelect = document.getElementById("id_destination_warehouse");
        const stockInfo = document.getElementById("stock-info");

        function resetWarehouses() {
            for (let option of sourceWarehouseSelect.options) {
                option.disabled = true;
            }
        }

        function resetDestinationOptions() {
            for (let option of destinationWarehouseSelect.options) {
                option.disabled = false;
            }
        }

        variantSelect.addEventListener("change", function() {
            const variantId = this.value;
            if (!variantId) return;

            fetch(`/movements/api/available-warehouses/?variant_id=${variantId}`)
                .then(response => response.json())
                .then(data => {
                    resetWarehouses();
                    resetDestinationOptions();
                    let infoText = "<strong>Disponibilidad por Bodega:</strong><ul>";

                    data.forEach(warehouse => {
                        for (let option of sourceWarehouseSelect.options) {
                            if (parseInt(option.value) === warehouse.id) {
                                option.disabled = false;
                            }
                        }
                        infoText += `<li>${warehouse.name}: ${warehouse.quantity} unidades</li>`;
                    });

                    infoText += "</ul>";
                    stockInfo.innerHTML = infoText;
                });
        });

        sourceWarehouseSelect.addEventListener("change", function() {
            const selectedSourceId = parseInt(this.value);
            resetDestinationOptions();
            for (let option of destinationWarehouseSelect.options) {
                if (parseInt(option.value) === selectedSourceId) {
                    option.disabled = true;
                }
            }
        });

        resetWarehouses();
        resetDestinationOptions();
    });
</script>

{% endblock %}
