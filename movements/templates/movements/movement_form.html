{% extends 'base.html' %}

{% block content %}
<div class="card mx-auto" style="max-width: 800px; margin-top: 40px;">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Crear Movimiento</h5>
    </div>

    <div class="card-block" style="padding: 25px;">
        <form method="post" action="{% url 'movement-create-submit' %}" id="movement-form">
            {% csrf_token %}

            <div class="form-group mb-4">
                <label for="id_variant" class="font-weight-bold">Variante</label>
                {{ form.variant }}
            </div>

            <div class="form-group mb-4">
                <label for="id_source_warehouse" class="font-weight-bold">Bodega de Origen</label>
                {{ form.source_warehouse }}
                <div id="stock-info" class="text-muted small mt-2"></div>
            </div>

            <div class="form-group mb-4">
                <label for="id_destination_warehouse" class="font-weight-bold">Bodega de Destino</label>
                {{ form.destination_warehouse }}
            </div>

            <div class="form-group mb-4">
                <label for="id_quantity" class="font-weight-bold">Cantidad</label>
                {{ form.quantity }}
            </div>

            <div class="form-group mb-4">
                <label for="id_reason" class="font-weight-bold">Raz√≥n</label>
                {{ form.reason }}
            </div>

            <div class="text-right">
                <button type="submit" class="btn btn-primary" style="border-radius: 20px; padding: 8px 25px;">
                    <i class="ti-check"></i> Crear Movimiento
                </button>
            </div>
        </form>
    </div>
</div>

<style>
    select, input[type="text"], input[type="number"], textarea {
        width: 100%;
        padding: 8px;
        border-radius: 5px;
        border: 1px solid #ced4da;
        font-size: 14px;
    }

    .form-group label {
        display: block;
        margin-bottom: 6px;
        color: #333;
    }

    .btn-primary:hover {
        background-color: #0056b3;
    }
</style>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const variantSelect = document.getElementById("id_variant");
        const sourceWarehouseSelect = document.getElementById("id_source_warehouse");
        const destinationWarehouseSelect = document.getElementById("id_destination_warehouse");
        const stockInfo = document.getElementById("stock-info");

        function resetWarehouses() {
            for (let option of sourceWarehouseSelect.options) {
                option.disabled = true;
            }
        }

        function resetDestinationOptions() {
            for (let option of destinationWarehouseSelect.options) {
                option.disabled = false;
            }
        }

        variantSelect.addEventListener("change", function() {
            const variantId = this.value;
            if (!variantId) return;

            fetch(`/movements/api/available-warehouses/?variant_id=${variantId}`)
                .then(response => response.json())
                .then(data => {
                    resetWarehouses();
                    resetDestinationOptions();
                    let infoText = "<strong>Disponibilidad por Bodega:</strong><ul>";

                    data.forEach(warehouse => {
                        for (let option of sourceWarehouseSelect.options) {
                            if (parseInt(option.value) === warehouse.id) {
                                option.disabled = false;
                            }
                        }
                        infoText += `<li>${warehouse.name}: ${warehouse.quantity} unidades</li>`;
                    });

                    infoText += "</ul>";
                    stockInfo.innerHTML = infoText;
                });
        });

        sourceWarehouseSelect.addEventListener("change", function() {
            const selectedSourceId = parseInt(this.value);
            resetDestinationOptions();
            for (let option of destinationWarehouseSelect.options) {
                if (parseInt(option.value) === selectedSourceId) {
                    option.disabled = true;
                }
            }
        });

        resetWarehouses();
        resetDestinationOptions();
    });
</script>
{% endblock %}
