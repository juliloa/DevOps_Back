{% extends 'base.html' %}
{% block content %}
<div class="card">
    <div class="card-header">
        <h5>Catálogo de Productos</h5>
        <div class="card-header-right">
            <button class="btn btn-primary btn-sm" data-toggle="modal" data-target="#createModal" style="font-size: 14px; border-radius: 20px; padding: 5px 15px;">
                <i class="ti-plus"></i> Nuevo Producto
            </button>
        </div>
    </div>

    <div class="card-block" style="padding: 20px 25px;">
        <div class="dt-responsive table-responsive">
            <table id="products-table" class="table table-striped table-bordered nowrap" style="width:100%">
                <thead>
                    <tr>
                        <th class="text-center">Nombre</th>
                        <th class="text-center">Descripción</th>
                        <th class="text-center">Categoría</th>
                        <th class="text-center">Imagen</th>
                        <th class="text-center">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for producto in productos %}
                    <tr>
                        <td>{{ producto.name }}</td>
                        <td>{{ producto.description|truncatechars:50 }}</td>
                        <td class="text-center">
                            {% if producto.category %}
                            <span class="badge badge-pill" style="background-color: #E3F2FD; color: #1976D2; border-radius: 12px;">
                                {{ producto.category.name }}
                            </span>
                            {% else %}
                            -
                            {% endif %}
                        </td>
                        <td class="text-center">
                            {% if producto.image_url %}
                            <img src="{{ producto.image_url }}" alt="{{ producto.name }}" style="height: 40px; border-radius: 4px;">
                            {% else %}
                            -
                            {% endif %}
                        </td>
                        <td class="text-center">
                            <fieldset class="btn-group" style="border:none; padding:0; margin:0;">
                                <!-- Editar -->
                                <button class="btn btn-sm" data-toggle="modal" data-target="#editModal-{{ producto.id }}" title="Editar"
                                    style="background-color: #E3F2FD; color: #1976D2; border-radius: 15px; border: 1px solid #BBDEFB;">
                                    <i class="ti-pencil"></i>
                                </button>
                                <!-- Eliminar -->
                                <button class="btn btn-sm" data-toggle="modal" data-target="#deleteModal-{{ producto.id }}" title="Eliminar"
                                    style="background-color: #FFEBEE; color: #D32F2F; border-radius: 15px; border: 1px solid #FFCDD2;">
                                    <i class="ti-trash"></i>
                                </button>
                                <!-- Ver variantes como link -->
                                <a href="{% url 'product-detail' producto.id %}" class="btn btn-sm"
                                   title="Ver Variantes"
                                   style="background-color: #E8F5E9; color: #388E3C; border-radius: 15px; border: 1px solid #C8E6C9; display: inline-flex; align-items: center; justify-content: center;">
                                    <i class="ti-eye"></i>
                                </a>
                            </fieldset>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modales por producto (fuera de la tabla) -->
{% for producto in productos %}
<!-- Editar -->
<div class="modal fade" id="editModal-{{ producto.id }}" tabindex="-1" aria-labelledby="editModalLabel-{{ producto.id }}" aria-hidden="true">
  <dialog class="modal-dialog" aria-modal="true">
    <form method="POST" action="{% url 'product-edit-post' producto.id %}" class="modal-content">
        {% csrf_token %}
        <div class="modal-header">
            <h5 class="modal-title" id="editModalLabel-{{ producto.id }}">Editar Producto</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Cerrar">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
        <div class="modal-body">
            {% include "products/product_form.html" with product=producto categories=categories %}
        </div>
        <div class="modal-footer">
            <button type="submit" class="btn btn-primary" style="border-radius: 20px; padding: 5px 20px;">
                <i class="ti-save"></i> Guardar
            </button>
        </div>
    </form>
  </dialog>
</div>

<!-- Eliminar -->
<div class="modal fade" id="deleteModal-{{ producto.id }}" tabindex="-1" aria-labelledby="deleteModalLabel-{{ producto.id }}" aria-hidden="true">
  <dialog class="modal-dialog" aria-modal="true">
    <form method="POST" action="{% url 'product-delete' producto.id %}" class="modal-content">
        {% csrf_token %}
        <div class="modal-header">
            <h5 class="modal-title" id="deleteModalLabel-{{ producto.id }}">Eliminar Producto</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Cerrar">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
        <div class="modal-body">
            ¿Estás seguro que deseas eliminar el producto <strong>{{ producto.name }}</strong>?
        </div>
        <div class="modal-footer">
            <button type="submit" class="btn btn-danger" style="border-radius: 20px; padding: 5px 20px;">
                <i class="ti-trash"></i> Eliminar
            </button>
            <button type="button" class="btn btn-secondary" data-dismiss="modal" style="border-radius: 20px; padding: 5px 20px;">
                <i class="ti-close"></i> Cancelar
            </button>
        </div>
    </form>
  </dialog>
</div>
{% endfor %}

<!-- Modal Crear Producto -->
<div class="modal fade" id="createModal" tabindex="-1" aria-labelledby="createModalLabel" aria-hidden="true">
  <dialog class="modal-dialog" aria-modal="true">
    <form method="POST" action="{% url 'product-create-post' %}" class="modal-content">
        {% csrf_token %}
        <div class="modal-header">
            <h5 class="modal-title" id="createModalLabel">Nuevo Producto</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Cerrar">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
        <div class="modal-body">
            {% include "products/product_form.html" with categories=categories %}
        </div>
        <div class="modal-footer">
            <button type="submit" class="btn btn-primary" style="border-radius: 20px; padding: 5px 20px;">
                <i class="ti-save"></i> Crear
            </button>
        </div>
    </form>
  </dialog>
</div>

<style>
    .card-block {
        padding: 1.25rem;
    }
    #products-table th {
        white-space: nowrap;
        background-color: #f8f9fa;
    }
    .btn-group .btn, .btn-group a.btn {
        margin-right: 5px;
        padding: 3px 10px;
        font-size: 13px;
        transition: all 0.3s ease;
    }
    .btn-group .btn:last-child, .btn-group a.btn:last-child {
        margin-right: 0;
    }
    .modal-footer .btn {
        margin-right: 10px;
    }
    .modal-footer .btn:last-child {
        margin-right: 0;
    }
    #products-table img {
        max-height: 40px;
        max-width: 60px;
        object-fit: contain;
    }
</style>
{% endblock %}
